---
# tasks file for prod
- name: Install packages
  apt:
    pkg:
      - docker.io
      - python3-pip
    update_cache: yes
    state: present

- name: Pip install docker
  pip:
    name: docker

- name: Create a volume
  community.docker.docker_volume:
    name: volume

- name: Create a web_data
  community.docker.docker_volume:
    name: web_data

- name: Start a conteiner build
  community.docker.docker_container:
    name: build
    state: started
    image: syrkashevav/build:v1.0
    volumes:
      - volume:/workdir

- name: Start a conteiner tomcat
  community.docker.docker_container:
    name: tomcat
    state: started
    image: tomcat:9.0.20-jre8-alpine
    volumes:
      - volume:/usr/local/tomcat/webapps/
      - web_data:/usr/local/tomcat/bin
    ports: 8081:8080

- name: Line test2
  lineinfile:
    dest: /var/lib/docker/volumes/web_data/_data/catalina.sh
    line: "{{ item }}"
    insertbefore: EOF
  with_items:
    - "\n"
    - 'CATALINA_OPTS="$CATALINA_OPTS -Dcom.sun.management.jmxremote'
    - '-Dcom.sun.management.jmxremote.port=8090'
    - '-Dcom.sun.management.jmxremote.ssl=false'
    - '-Dcom.sun.management.jmxremote.authenticate=false"'

- name: Download jar-file
  get_url:
    url: http://archive.apache.org/dist/tomcat/tomcat-9/v9.0.8/bin/extras/catalina-jmx-remote.jar
    dest: /jarfile
  tags: pre-install

- name: Copy a jar-file into the container
  community.docker.docker_container_copy_into:
    container: tomcat
    path: /jarfile
    container_path: /usr/local/tomcat/lib/catalina-jmx-remote.jar

- name: Restart a container tomcat
  community.docker.docker_container:
    name: tomcat
    state: started
    image: tomcat:9.0.20-jre8-alpine
    restart: true
    volumes:
      - volume:/usr/local/tomcat/webapps/
      - web_data:/usr/local/tomcat/bin
    ports:
      - "8081:8080"

- name: Stop a container build
  community.docker.docker_container:
    name: build
    state: stopped

- name: Remove a container build
  community.docker.docker_container:
    name: build
    state: absent

- name: Remove an image on Docker Hub
  community.docker.docker_image:
    name: syrkashevav/build
    tag: v1.0
    state: absent
